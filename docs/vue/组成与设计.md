# Vueè®¾è®¡æ€è·¯

## `é¡¹ç›®æ–‡ä»¶ç»“æ„`

åœ¨`Vue`é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰æ ¸å¿ƒçš„ä»£ç éƒ½æ˜¯åœ¨`src`ç›®å½•ä¸‹å®Œæˆï¼Œä¸ºäº†æ›´å¥½çš„äº†è§£`Vue`çš„åº•å±‚å®ç°ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹`src`ç›®å½•ä¸‹ä»£ç çš„ç»„ç»‡æƒ…å†µï¼Œä»å…¨å±€å…¥æ‰‹ï¼Œåœ¨è„‘æµ·é‡Œç•™ä¸‹ç®€å•çš„å°è±¡ï¼Œæ–¹ä¾¿åç»­çš„å­¦ä¹ ã€‚ï¼ˆæ³¨æ„ï¼šå½“å‰ä½¿ç”¨`Vue`çš„ç‰ˆæœ¬ä¸º`2.6.12`ï¼Œä¸åŒç‰ˆæœ¬çš„å†…å®¹å¯èƒ½ä¼šæœ‰æ‰€å·®å¼‚ï¼‰

```javascript
.
â”œâ”€â”€ compiler  // ç¼–è¯‘æ¨¡å—ï¼šå°† template ç¼–è¯‘æˆä¸ºå¯ä»¥ç”Ÿæˆ vnode çš„ render å‡½æ•°
â”‚   â”œâ”€â”€ codeframe.js
â”‚   â”œâ”€â”€ codegen             // ä»£ç ç”Ÿæˆæ–‡ä»¶ï¼šæ ¹æ® ast æ ‘å¯ç”Ÿæˆ vnode çš„ renderä»£ç 
â”‚   â”œâ”€â”€ create-compiler.js  // åˆ›å»ºç¼–è¯‘å™¨çš„å·¥å‚å‡½æ•°
â”‚   â”œâ”€â”€ directives          // æŒ‡ä»¤è§£æï¼šv-on, v-bind, v-model
â”‚   â”œâ”€â”€ error-detector.js   
â”‚   â”œâ”€â”€ helpers.js          // ç¼–è¯‘ç›¸å…³æ–¹æ³•ï¼Œå¦‚å±æ€§è·å–ç­‰æ–¹æ³•
â”‚   â”œâ”€â”€ index.js            // å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ optimizer.js        // ç¼–è¯‘ä¼˜åŒ–ï¼šå°† ast æ ‘è¿›è¡Œä¼˜åŒ–
â”‚   â”œâ”€â”€ parser                      // html è§£ææ–‡ä»¶ï¼šå°† template è§£ææˆ ast æ ‘ğŸŒ²
â”‚   â””â”€â”€ to-function.js      // åˆ›å»ºç¼–è¯‘å™¨çš„å·¥å‚å‡½æ•°
â”œâ”€â”€ core     // æ„é€ å‡½æ•°æ ¸å¿ƒæ¨¡å—ï¼šæ„å»ºVueæ„é€ å‡½æ•°ï¼Œæ·»åŠ åŸå‹æ–¹æ³•ï¼Œå®ç°å®Œæˆæ¸²æŸ“æµç¨‹çš„_initæ–¹æ³•
â”‚   â”œâ”€â”€ components  // è‡ªå¸¦çš„å…¨å±€ç»„ä»¶ï¼Œå¦‚ keep-alive
â”‚   â”œâ”€â”€ config.js   // é…ç½®ç›¸å…³
â”‚   â”œâ”€â”€ global-api  // å…¨å±€apiï¼Œå¦‚ Vue.use, extend, mixin, componentç­‰æ–¹æ³•
â”‚   â”œâ”€â”€ index.js    // å…¥å£æ–‡ä»¶ï¼Œåœ¨ Vue ä¸ŠæŒ‚è½½å…¨å±€æ–¹æ³•å¹¶å¯¼å‡º Vue
â”‚   â”œâ”€â”€ instance    // æ„é€ å‡½æ•°èµ·å§‹ä½ç½®
â”‚   â”œâ”€â”€ observer    // å“åº”å¼åŸç†
â”‚   â”œâ”€â”€ util        // ä¸€äº›å·¥å…·æ–¹æ³•ï¼ŒåŒ…å« mergeOptions, nextTick ç­‰æ–¹æ³•çš„å®ç°
â”‚   â””â”€â”€ vdom        // è™šæ‹Ÿ dom
â”œâ”€â”€ platforms // å¹³å°ç›¸å…³ï¼ŒåŒ…å«ä¸åŒå¹³å°çš„ä¸åŒæ„å»ºå…¥å£ï¼Œè¿™é‡Œä¸»è¦ç ”ç©¶webç«¯
â”‚   â”œâ”€â”€ weex
â”‚   â””â”€â”€ web
â”‚       â”œâ”€â”€ compiler   // ä¸å¹³å°ç›¸å…³çš„ç¼–è¯‘
â”‚       â”œâ”€â”€ entry-compiler.js // vue-template-compiler åŒ…çš„å…¥å£æ–‡ä»¶
â”‚       â”œâ”€â”€ entry-runtime-with-compiler.js // æ„å»ºå…¥å£ï¼ŒåŒ…å«ç¼–è¯‘å™¨
â”‚       â”œâ”€â”€ entry-runtime.js  // æ„å»ºå…¥å£ï¼Œä¸åŒ…å«ç¼–è¯‘å™¨ï¼Œä¸æ”¯æŒ template è½¬æ¢ render
â”‚       â”œâ”€â”€ entry-server-basic-renderer.js
â”‚       â”œâ”€â”€ entry-server-renderer.js
â”‚       â”œâ”€â”€ runtime   // ä¸å¹³å°ç›¸å…³çš„æ„å»º
â”‚       â”œâ”€â”€ server
â”‚       â””â”€â”€ util
â”‚
â”œâ”€â”€ server    // æœåŠ¡ç«¯æ¸²æŸ“ç›¸å…³
â”œâ”€â”€ sfc       // åŒ…å«å•æ–‡ä»¶ç»„ä»¶(.vueæ–‡ä»¶)çš„è§£æé€»è¾‘ï¼Œç”¨äºvue-template-compileråŒ…
â””â”€â”€ shared    // ä»£ç åº“é€šç”¨ä»£ç 
    â”œâ”€â”€ constants.js
    â””â”€â”€ util.js
```

ä»¥ä¸Šæ˜¯`Vue`é¡¹ç›®ä¸­ä¸»è¦æ–‡ä»¶ç›®å½•ï¼Œé‡Œé¢é™„å¸¦ä¸€äº›æ³¨é‡Šï¼Œè®²è§£äº†æ¯”è¾ƒä¸»è¦æ¨¡å—çš„åŠŸèƒ½åŠä½œç”¨ã€‚åˆšå¼€å§‹å­¦ä¹ æ—¶åªåšç®€å•äº†è§£å³å¯ï¼Œåé¢æˆ‘ä»¬ä¼šé€æ­¥è¯¦ç»†å­¦ä¹ å…¶ä¸­çš„ä¸€äº›æ¨¡å—ï¼Œä»è€Œä»åŸç†çº§åˆ«ç†è§£æ•´ä¸ª`Vue`é¡¹ç›®çš„è®¾è®¡ä¸å®ç°ã€‚



## `Vue`çš„çœŸé¢ç›®

è¦æƒ³çœŸæ­£çš„äº†è§£`Vue`æ˜¯æ€æ ·çš„ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°`Vue`æ˜¯å’‹å“ªé‡Œè¢«å®šä¹‰çš„ã€‚æˆ‘ä»¬å…ˆæ‰¾åˆ°`package.json`æ–‡ä»¶ä¸‹çš„`scripts`é…ç½®ã€‚`scripts`é‡Œå­˜æ”¾çš„éƒ½æ˜¯è¿è¡Œå‘½ä»¤çš„åˆ«åå½¢å¼ï¼Œé€šè¿‡å‘½ä»¤å¯ä»¥è½»æ¾æ‰¾åˆ°å¯¹åº”å‘½ä»¤æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚

```javascript
"scripts": {
    "dev": "rollup -w -c scripts/config.js --environment TARGET:web-full-dev"
 }
```

è¿™é‡Œå½“è¿è¡Œ`dev`å‘½ä»¤å®é™…ä¸Šæ˜¯è¿è¡Œ`scripts/config.js`æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬æ‰¾åˆ°`scripts/config.js`æ–‡ä»¶ã€‚

é€šè¿‡è¿è¡Œå‘½ä»¤å‚æ•°æˆ‘ä»¬å¯ä»¥çŸ¥é“`process.env.TARGET`çš„å€¼ä¸º`web-full-dev`ï¼Œå› æ­¤å¯ä»¥åœ¨`builds`é‡Œæ‰¾åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹

```javascript
const builds = {
  'web-full-dev': {
      entry: resolve('web/entry-runtime-with-compiler.js'),
      dest: resolve('dist/vue.js'),
      format: 'umd',
      env: 'development',
      alias: { he: './entity-decoder' },
      banner
   }
  ...
}

module.exports = genConfig(process.env.TARGET)
```

é€šè¿‡`entry`ï¼Œæˆ‘ä»¬æ‰¾åˆ°`web/entry-runtime-with-compiler.js`æ–‡ä»¶ï¼š

```javascript
import Vue from './runtime/index'

const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  ...
}
Vue.compile = compileToFunctions

export default Vue
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºæ‰¾åˆ°äº†`Vue`ç›¸å…³çš„æ–‡ä»¶ï¼Œè¿™ä¹Ÿæ˜¯`Vue`çš„èµ·å§‹å…¥å£ã€‚æ¥ç€æ ¹æ®`Vue`çš„å¼•å…¥è·¯å¾„ï¼Œæ‰¾åˆ°`./runtime/index`æ–‡ä»¶ï¼š

```javascript
import Vue from 'core/index'
...
Vue.prototype.__patch__ = inBrowser ? patch : noop
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  ...
}
export default Vue
```

è¿™é‡Œè¿˜ä¸æ˜¯`Vue`çœŸæ­£çš„èµ·å§‹ç‚¹ï¼Œç»§ç»­æŸ¥æ‰¾`core/index`æ–‡ä»¶ï¼š

```javascript
import Vue from './instance/index'
initGlobalAPI(Vue)
...
Vue.version = '__VERSION__'
export default Vue
```

å‘ç°ä»ç„¶ä¸æ˜¯`Vue`çš„èµ·å§‹ç‚¹ï¼Œç»§ç»­æŸ¥æ‰¾`'./instance/index'`æ–‡ä»¶ï¼š

```javascript
import { initMixin } from './init'
import { stateMixin } from './state'
import { renderMixin } from './render'
import { eventsMixin } from './events'
import { lifecycleMixin } from './lifecycle'
import { warn } from '../util/index'

// Vue æ„é€ å‡½æ•°
function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}

// å‘åŸå‹ä¸Šæ·»åŠ æ–¹æ³•å±æ€§
initMixin(Vue)
stateMixin(Vue)
eventsMixin(Vue)
lifecycleMixin(Vue)
renderMixin(Vue)

export default Vue
```

å¥½äº†ï¼Œå¤§åŠŸå‘Šæˆï¼è´¹åŠ²åƒè¾›ä¸‡è‹¦ç»ˆäºæ‰¾åˆ°äº†`Vue`çš„çœŸæ­£å®šä¹‰çš„ä½ç½®ï¼å¯ä»¥çœ‹å‡º`Vue`å…¶å®å°±æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè€Œæ„é€ å‡½æ•°å†…éƒ¨ä»…ä»…åªæ˜¯è°ƒç”¨äº†`_init`æ–¹æ³•ï¼Œçœ‹ä¸Šå»éå¸¸ç®€å•ã€‚ä½†æ˜¯`Vue`æ˜¯å¦‚ä½•é€šè¿‡è¿™ä¹ˆç®€å•çš„å®šä¹‰å®ç°é‚£ä¹ˆå¤æ‚çš„åŠŸèƒ½å‘¢ï¼Ÿè¿™é‡Œå°±è¦æ¶‰åŠåˆ°`æ„é€ å‡½æ•°`ã€`åŸå‹`ã€`å®ä¾‹`çš„æ¦‚å¿µäº†ï¼Œä¸äº†è§£è¿™äº›æ¦‚å¿µçš„å»ºè®®å‚è€ƒã€Šjavascripté«˜çº§è®¾è®¡ç¨‹åºã€‹ä¸­åŸå‹ç« èŠ‚æ¥è¿›è¡Œå­¦ä¹ ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸‹æ–¹ä¸‰ä¸ªæ–¹é¢æ¥ä»‹ç»`Vue`çš„å®ç°ã€‚

1. åŸå‹æ–¹æ³•å±æ€§ï¼šé€šè¿‡ 5 ä¸ª `init` æ–¹æ³•ï¼Œå‘`Vue`çš„åŸå‹ä¸Šæ·»åŠ æ–¹æ³•ï¼Œ
2. é™æ€æ–¹æ³•å±æ€§ï¼šåœ¨å¯¼å…¥`Vue`æ„é€ å‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œå‘`Vue`æ„é€ å‡½æ•°ä¸Šæ·»åŠ é™æ€æ–¹æ³•ï¼Œä¹Ÿæœ‰å‘åŸå‹ä¸Šæ·»åŠ æ–¹æ³•
3. å®ä¾‹åŒ–ï¼šåœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œ`_init`æ–¹æ³•ï¼Œå®Œæˆæ•´ä¸ª`Vue`åˆå§‹åŒ–åˆ°æ¸²æŸ“çš„é€»è¾‘ã€‚



## Vueçš„åŸå‹æ–¹æ³•å±æ€§

### `initMixin`

`initMixin`æ–¹æ³•ä¸»è¦å®ç°äº†`_init`æ–¹æ³•ã€‚

```javascript
export function initMixin (Vue: Class<Component>) {
  Vue.prototype._init = function (options?: Object) {
    // init å®ç°å†…å®¹ï¼Œç”±äºè¿™é‡Œä»…åšæ¦‚è§ˆï¼Œæ‰€ä»¥å…·ä½“å®ç°å‡å·²çœç•¥
    ... 
  }
}
```

ä»ä¸Šé¢`Vue`æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨å®ä¾‹åŒ–æ—¶æœ‰è¢«è°ƒç”¨ï¼Œå®ƒä¸»è¦çš„ä½œç”¨æ˜¯å®ç°ï¼šé€‰é¡¹çš„åˆå¹¶ï¼Œæ•°æ®åˆå§‹åŒ–ï¼ˆå¦‚å“åº”å¼å¤„ç†ï¼‰ï¼Œä»¥åŠè§¦å‘ç¼–è¯‘å’Œæ¸²æŸ“çš„æµç¨‹ï¼Œæ‰€ä»¥ååˆ†é‡è¦ã€‚è¿™é‡Œä¹Ÿåªæ˜¯å…ˆåšä¸€ä¸ªäº†è§£ï¼Œåç»­çš„å®ä¾‹åŒ–ç« èŠ‚å°†éƒ½ä¼šä»è¿™ä¸ªæ–¹æ³•å¼€å§‹åˆ†æã€‚



### `stateMixin`

`stateMixin`ä¸»è¦å®ç°äº†`data,props`çš„ä»£ç†åŠŸèƒ½ï¼Œå³å½“æˆ‘ä»¬è®¿é—®`$data`æ—¶ï¼Œå®é™…è®¿é—®çš„æ˜¯`_data`ã€‚å¦å¤–åœ¨éç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä¼šå¯¹`$data,$props`è¿›è¡Œ `set`å¤„ç†ï¼Œæ¯æ¬¡è®¾ç½®æ–°çš„å€¼æ—¶éƒ½ä¼šæ‰“å°æç¤ºï¼Œæ‰€ä»¥å®é™…ä¸Š`$data,$props`éƒ½æ˜¯åªè¯»å±æ€§ã€‚

```javascript
export function stateMixin (Vue: Class<Component>) {
  const dataDef = {}
  dataDef.get = function () { return this._data }
  const propsDef = {}
  propsDef.get = function () { return this._props }
  // åªè¯»å±æ€§
  if (process.env.NODE_ENV !== 'production') {
    dataDef.set = function () {
      warn(
        'Avoid replacing instance root $data. ' +
        'Use nested data properties instead.',
        this
      )
    }
    propsDef.set = function () {
      warn(`$props is readonly.`, this)
    }
  }
  Object.defineProperty(Vue.prototype, '$data', dataDef)
  Object.defineProperty(Vue.prototype, '$props', propsDef)
  Vue.prototype.$set = set
  Vue.prototype.$delete = del
  Vue.prototype.$watch = function () { ... }
}
```

é™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œè¿˜åœ¨`Vue`åŸå‹ä¸ŠæŒ‚è½½äº†æ¯”è¾ƒå¸¸è§çš„ä¸‰ä¸ªæ–¹æ³•ï¼š`$set`ï¼Œ`$delete`ï¼Œ`$watch`ã€‚



### `eventsMixin`

å’Œ`node`é‡Œ`EventEmitter`ç±»ä¼¼ï¼Œ`eventsMixin`å®ç°äº†å››ä¸ªæ–¹æ³•ï¼š`$on,$off,$once,$emit`ï¼Œç”¨äºç›‘å¬ï¼Œè§¦å‘ï¼Œé”€æ¯äº‹ä»¶ã€‚

```javascript
export function eventsMixin (Vue: Class<Component>) {
  const hookRE = /^hook:/
  Vue.prototype.$on = function () { ... }
  Vue.prototype.$once = function () { ... }
  Vue.prototype.$off = function () { ... }
  Vue.prototype.$emit = function () { ... }
}
```



### `lifecycleMixin`

`lifecycleMixin`å®ç°äº†ä¸‰ä¸ªæ–¹æ³•ï¼š`_update`æ–¹æ³•éå¸¸é‡è¦ï¼Œå®ƒä¸»è¦è´Ÿè´£å°†`vnode`ç”ŸæˆçœŸå®èŠ‚ç‚¹ã€‚

```javascript
export function lifecycleMixin (Vue: Class<Component>) {
  // æ›´æ–°ï¼Œå°† vnode ç”Ÿæˆ çœŸå®èŠ‚ç‚¹
  Vue.prototype._update = function () { ... }
  // å¼ºåˆ¶åˆ·æ–°
  Vue.prototype.$forceUpdate = function () { ... }
  // é”€æ¯
  Vue.prototype.$destroy = function () { ... }
}
```



### `renderMixin`

`renderMixin`ä¸»è¦åšäº†ä¸‰é¡¹å·¥ä½œ

```javascript
export function renderMixin (Vue: Class<Component>) {
  installRenderHelpers(Vue.prototype)

  Vue.prototype.$nextTick = function (fn: Function) {
    return nextTick(fn, this)
  }
  
  Vue.prototype._render = function (): VNode {
    return vnode
  }
}
```



1. `installRenderHelpers`å‡½æ•°ç”¨äºæ·»åŠ `render`ç›¸å…³æ–¹æ³•ï¼Œåœ¨ç¼–è¯‘ç¯èŠ‚æœ€åç”Ÿæˆçš„ä»£ç ï¼Œéƒ½æ˜¯ç”±è¿™äº›æ–¹æ³•æ‹¼æ¥è€Œæˆçš„ä»£ç ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯éå¸¸çš„é‡è¦ï¼Œåœ¨è¿™é‡Œå…ˆæ··ä¸ªçœ¼ç†Ÿã€‚

```javascript
  target._o = markOnce
  target._n = toNumber
  target._s = toString
  target._l = renderList
  target._t = renderSlot
  target._q = looseEqual
  target._i = looseIndexOf
  target._m = renderStatic
  target._f = resolveFilter
  target._k = checkKeyCodes
  target._b = bindObjectProps
  target._v = createTextVNode
  target._e = createEmptyVNode
  target._u = resolveScopedSlots
  target._g = bindObjectListeners
  target._d = bindDynamicKeys
  target._p = prependModifier
```

1. `$nextTick`æ–¹æ³•ï¼Œåœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯è§¦å‘ï¼Œæ¶‰åŠåˆ°äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚
2. `_render`æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆ`vnode`ã€‚



## Vueçš„é™æ€æ–¹æ³•å±æ€§

é€šè¿‡ä¸Šé¢5ä¸ª`init`æ–¹æ³•æˆ‘ä»¬å·²ç»äº†è§£äº†è®¸å¤šåŸå‹æ–¹æ³•çš„æ·»åŠ è¿‡ç¨‹ï¼Œä½†æ˜¯åœ¨`Vue`ä¸­è¿˜æœ‰å¾ˆå¤šå…¨å±€æ–¹æ³•ï¼Œæ¯”å¦‚`Vue.component,Vue.use`ç­‰æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯æ„é€ å‡½æ•°çš„é™æ€å±æ€§ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹è¿™äº›é™æ€å±æ€§æ˜¯å¦‚ä½•æ·»åŠ çš„ã€‚ä¸å¯»æ‰¾`Vue`çš„èµ·å§‹ä½ç½®è¿‡ç¨‹æ°æ°ç›¸åï¼Œè¿™æ¬¡æˆ‘ä»¬ä»`Vue`çš„èµ·å§‹æ–‡ä»¶å‡ºå‘ï¼Œçœ‹çœ‹æœ€åå¯¼å‡ºçš„`Vue`æ˜¯æ€æ ·çš„ã€‚



### `/src/core/index.js`æ–‡ä»¶

è¿™æ˜¯ç¬¬ä¸€å±‚å¼•å…¥`Vue`æ„é€ å‡½æ•°çš„æ–‡ä»¶

```javascript
import { initGlobalAPI } from './global-api/index'

initGlobalAPI(Vue)

// ... ä¸­é—´çœç•¥

Vue.version = '__VERSION__'
```

è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹`initGlobalAPI`æ–¹æ³•ï¼Œæ‰“å¼€`core/global-api/index.js`æ–‡ä»¶

```javascript
export function initGlobalAPI (Vue: GlobalAPI) {
  Vue.util = {
    warn,
    extend,
    mergeOptions,
    defineReactive
  }

  Vue.set = set
  Vue.delete = del
  Vue.nextTick = nextTick

  // 2.6 explicit observable API
  Vue.observable = <T>(obj: T): T => {
    observe(obj)
    return obj
  }

  Vue.options = Object.create(null)
  ASSET_TYPES.forEach(type => {
    Vue.options[type + 's'] = Object.create(null)
  })

  Vue.options._base = Vue

  extend(Vue.options.components, builtInComponents)

  initUse(Vue)
  initMixin(Vue)
  initExtend(Vue)
  initAssetRegisters(Vue)
}
```

è¿™é‡ŒæŒ‚è½½äº†å¾ˆå¤šé™æ€æ–¹æ³•ï¼Œ`Vue`ä¸­å¤§å¤šæ•°çš„å…¨å±€æ–¹æ³•éƒ½åœ¨è¿™ä¸ªä½ç½®æ·»åŠ çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç€é‡åˆ†æä¸€ä¸‹`options`ï¼š

```javascript
  import builtInComponents from '../components/index'  

  Vue.options = Object.create(null)
  ASSET_TYPES.forEach(type => {
    Vue.options[type + 's'] = Object.create(null)
  })

  Vue.options._base = Vue

  extend(Vue.options.components, builtInComponents)  
```

å¯ä»¥çœ‹å‡ºï¼Œåœ¨`Vue`æ„é€ å‡½æ•°ä¸Šæ·»åŠ äº†ä¸€ä¸ª`options`å±æ€§ï¼ˆæ³¨æ„ï¼è¿™é‡Œæ˜¯é™æ€å±æ€§ï¼Œä¸ºæ„é€ å‡½æ•°æ‰€æœ‰ï¼ŒåŒºåˆ«äºåœ¨å®ä¾‹åŒ–ä¼ å…¥çš„`options`ï¼‰ã€‚éšååˆé€šè¿‡éå†`ASSET_TYPES`ï¼Œåœ¨`options`ä¸Šæ·»åŠ äº†`components,directives,filters`æ–¹æ³•ã€‚å¦å¤–è¿˜æ·»åŠ äº†`_base`ï¼ŒæŒ‡å‘å½“å‰æ„é€ å‡½æ•°ã€‚æœ€åé€šè¿‡`extend`æ–¹æ³•å°†`builtInComponents`åˆå¹¶åˆ°`options.components`å½“ä¸­ã€‚è¿™é‡Œçš„`builtInComponents`å®é™…ä¸Šå°±æ˜¯`Vue`è‡ªå¸¦çš„ç»„ä»¶ï¼Œå³`keep-alive`ç»„ä»¶ã€‚æ‰€ä»¥æœ€ç»ˆ`Vue.options`çš„å†…å®¹å¦‚ä¸‹ï¼š

```javascript
// Vue.options å†…å®¹
{
    components: {
    KeepAlive
  },
  filters: {},
  directives: {},
  _base: Vue
}
```

è¿™é‡Œä¹‹æ‰€ä»¥é¢å¤–æèµ·ï¼Œæ˜¯å› ä¸ºåœ¨åç»­é€‰é¡¹åˆå¹¶æ—¶ï¼Œä¼šä½¿ç”¨æ­¤å¤„çš„`options`è¿›è¡Œåˆå¹¶ã€‚



### `/src/platforms/web/runtime/index.js`æ–‡ä»¶

è¿™é‡Œæ˜¯ç¬¬äºŒå±‚å¼•å…¥`Vue`çš„æ–‡ä»¶ï¼Œä¸»è¦ç»™`Vue`å¤„ç†å¹³å°ç›¸å…³çš„ä¸€äº›æ–¹æ³•

```javascript
import Vue from 'core/index'
import config from 'core/config'
import { extend, noop } from 'shared/util'
import { mountComponent } from 'core/instance/lifecycle'
import { devtools, inBrowser } from 'core/util/index'

import {
  query,
  mustUseProp,
  isReservedTag,
  isReservedAttr,
  getTagNamespace,
  isUnknownElement
} from 'web/util/index'

import { patch } from './patch'
import platformDirectives from './directives/index'
import platformComponents from './components/index'

// install platform specific utils
Vue.config.mustUseProp = mustUseProp
Vue.config.isReservedTag = isReservedTag
Vue.config.isReservedAttr = isReservedAttr
Vue.config.getTagNamespace = getTagNamespace
Vue.config.isUnknownElement = isUnknownElement

// install platform runtime directives & components
extend(Vue.options.directives, platformDirectives)
extend(Vue.options.components, platformComponents)

Vue.prototype.__patch__ = inBrowser ? patch : noop
Vue.prototype.$mount = function () { ... }

export default Vue
```

è¿™é‡Œé¦–å…ˆç»™`Vue.config`æ·»åŠ äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œæ³¨æ„ï¼Œè¿™äº›æ–¹æ³•ä¹‹æ‰€ä»¥åœ¨è¿™é‡Œæ·»åŠ è€Œä¸æ˜¯åœ¨`core/index.js`æ–‡ä»¶é‡Œæ·»åŠ ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„æ–¹æ³•éƒ½ä¸å¹³å°ç›¸å…³ï¼Œä¸åŒçš„å¹³å°çš„æ–¹æ³•å®ç°ä¹Ÿä¼šä¸ä¸€æ ·ã€‚

```javascript
extend(Vue.options.directives, platformDirectives)
extend(Vue.options.components, platformComponents)
```

è¿™ä¸¤ä¸ª`extend`å®é™…ä¸Šè¿›ä¸€æ­¥æ‰©å……äº†`Vue.options`æ–¹æ³•ï¼Œæ‰©å……åçš„å†…å®¹å¦‚ä¸‹

```javascript
// Vue.options å†…å®¹
{
    components: {
    KeepAlive,
    // æ–°å¢ platformComponents
    Transition,
    // æ–°å¢ platformComponents
    TransitionGroup
  },
  filters: {},
  directives: {
    // æ–°å¢ platformDirectives
    model,
    // æ–°å¢ platformDirectives
    show
  },
  _base: Vue
}
```

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸ç”¨æ³¨å†Œä¹Ÿèƒ½å…¨å±€ä½¿ç”¨`v-model,v-show`çš„åŸå› äº†ï¼Œå› ä¸º`Vue`å·²ç»å¸®æˆ‘ä»¬å…¨å±€æ³¨å†Œäº†ã€‚



### `/src/platforms/web/entry-runtime-with-compiler.js`æ–‡ä»¶

è¿™æ˜¯æœ€åä¸€å±‚å¼•å…¥`Vue`äº†

```javascript
import Vue from './runtime/index'
...

const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
    
    ...
    
  return mount.call(this, el, hydrating)
}

Vue.compile = compileToFunctions

export default Vue
```

è¿™é‡Œä¸»è¦æ˜¯é‡æ–°å®ç°äº†`$mount`æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆåŸå…ˆåœ¨`runtime/index.js`æ–‡ä»¶é‡Œå®ç°äº†`$mount`æ–¹æ³•ï¼Œè¿™é‡Œåˆè¦é‡æ–°å®ç°ä¸€éå‘¢ï¼Ÿå› ä¸º`runtime/index.js`é‡Œçš„`$mount`ä¸ç¼–è¯‘æ˜¯æ— å…³çš„ï¼Œæ— æ³•å¤„ç†`template`æ¨¡æ¿ä»£ç ï¼Œè€Œè¿™é‡Œé‡å†™çš„`$mount`å®é™…ä¸Šè¿˜æ˜¯è°ƒç”¨äº†`runtime/index.js`é‡Œçš„`$mount`ï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œå¢åŠ äº†ä»`template`åˆ°`render`çš„ç¼–è¯‘è¿‡ç¨‹ã€‚



## å®ä¾‹åŒ–è¿‡ç¨‹

å‰é¢å·²ç»å°†`Vue`çš„å„ç§æ–¹æ³•å±æ€§æŒ‚è½½å®Œæ¯•ï¼Œç°åœ¨åˆ™æ˜¯éœ€è¦è¿›è¡Œå®ä¾‹åŒ–äº†ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ä¹‹å‰æåˆ°çš„`_init`æ–¹æ³•ã€‚æ‰“å¼€`/src/core/instance/init.js`æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
    ...

    // 1. åˆå¹¶options
    if (options && options._isComponent) {
      initInternalComponent(vm, options)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
  
    ...

    // 2. åˆå§‹åŒ–æ•°æ®
    initLifecycle(vm)
    initEvents(vm)
    initRender(vm)
    callHook(vm, 'beforeCreate')
    initInjections(vm) // resolve injections before data/props
    initState(vm)
    initProvide(vm) // resolve provide after data/props
    callHook(vm, 'created')

    // 3. æŒ‚è½½
    if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }
  }
```

åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

é˜¶æ®µä¸€ï¼šåˆå¹¶é€‰é¡¹ï¼Œå°† `Vue.options`å’Œä¼ å…¥çš„`options`è¿›è¡Œåˆå¹¶

é˜¶æ®µäºŒï¼šåˆå§‹åŒ–æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œå“åº”å¼å¤„ç†

é˜¶æ®µä¸‰ï¼šç¼–è¯‘ä»£ç ï¼Œå¾—åˆ°`render`å‡½æ•°ï¼Œå°†`vnode`ç”ŸæˆçœŸå®èŠ‚ç‚¹ï¼Œå¹¶æŒ‚è½½åˆ°ç•Œé¢

ç”±äºè¿™éƒ¨åˆ†æ¯”è¾ƒæ ¸å¿ƒï¼Œä¸”éš¾ä»¥ç†è§£ï¼Œè¿™é‡Œä»…åšäº†è§£ï¼Œåç»­ä¼šé€ä¸€è¿›è¡Œåˆ†æã€‚



## Vueçš„æ•´ä½“è®¾è®¡

é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»å¯¹`VueåŸå‹æ–¹æ³•`ï¼Œ`Vueé™æ€æ–¹æ³•å±æ€§`ï¼Œ`Vueå®ä¾‹åŒ–è¿‡ç¨‹`æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨å¼ å›¾æ€»ç»“ä¸‹æ•´ä½“çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯Vueæ•´ä½“çš„è®¾è®¡æ€è·¯ã€‚

![Vueç»„æˆä¸è®¾è®¡.png](./design/vue-design.png)

æ€»ç»“ä¸‹æ¥å°±æ˜¯ï¼š

1. æ„å»ºä¸€ä¸ªå…·æœ‰å®Œå¤‡åŠŸèƒ½çš„æ„é€ å‡½æ•°ï¼Œå› æ­¤åœ¨ä¸Šé¢æ·»åŠ å„ä¸ªæ¨¡å—éœ€è¦çš„æ–¹æ³•å±æ€§ã€‚åŒ…æ‹¬åŸå‹æ–¹æ³•å±æ€§å’Œé™æ€æ–¹æ³•å±æ€§ã€‚
2. è¿›è¡Œå®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–è¿‡ç¨‹ä¸­è¿›è¡Œå„ç§å¤„ç†ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šé€‰é¡¹åˆå¹¶ï¼Œæ•°æ®å“åº”å¼å¤„ç†ï¼Œç¼–è¯‘ï¼Œè™šæ‹Ÿ`DOM`æ›´æ–°ç­‰ç­‰ã€‚



è¿™é‡Œçš„æè¿°æ¯”è¾ƒç¬¼ç»Ÿï¼Œæ—¨åœ¨ä»æ•´ä½“ä¸Šæ¥å¯¹Vueè¿›è¡Œä¸€ä¸ªäº†è§£ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æå®ä¾‹åŒ–çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä»è€Œç”±ç‚¹åŠé¢çš„äº†è§£Vueã€‚ä¸‹ä¸€ç« èŠ‚æˆ‘ä»¬å°†å¼€å§‹`Vue`æ ¸å¿ƒä»£ç çš„æ­£å¼å­¦ä¹ ã€‚

